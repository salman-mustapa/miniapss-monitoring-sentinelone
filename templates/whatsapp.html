<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>WhatsApp - Sentinel Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0b0f10; color:#8aff9b; font-family: monospace; }
    .card { background:#071012; border:1px solid #0f4; }
    .term { background:#00110a; color:#8aff9b; padding:12px; font-family: monospace; border-radius:6px; height:220px; overflow:auto; }
    .btn-sm { font-family: monospace; }
  </style>
  <script>
    async function apiGet(path, qs="") {
      const r = await fetch(path + (qs ? ("?"+qs):""), {cache:"no-store"});
      return r.json();
    }
    async function showSessions() {
      const out = document.getElementById("output");
      out.innerText = "Loading sessions...";
      const res = await apiGet("/api/sessions");
      out.innerText = JSON.stringify(res, null, 2);
    }
    async function connectSession() {
      const session = prompt("Session name", "{{ wa.session_name or 'default' }}");
      if(!session) return;
      const form = new URLSearchParams();
      form.append("session", session);
      const r = await fetch("/api/connect", {method:"POST", body: form});
      const j = await r.json();
      document.getElementById("output").innerText = JSON.stringify(j, null, 2);
    }
    async function showQR() {
      const q = document.getElementById("session_qr").value || "{{ wa.session_name or 'default' }}";
      const res = await apiGet("/api/qr", "session="+encodeURIComponent(q));
      document.getElementById("output").innerText = JSON.stringify(res, null, 2);
    }
    async function listGroups() {
      const q = document.getElementById("session_qr").value || "{{ wa.session_name or 'default' }}";
      const res = await apiGet("/api/groups", "session="+encodeURIComponent(q));
      document.getElementById("output").innerText = JSON.stringify(res, null, 2);
    }
    async function fetchGroups() {
      const q = document.getElementById("session_qr").value || "{{ wa.session_name or 'default' }}";
      const res = await apiGet("/api/fetch-groups", "session="+encodeURIComponent(q));
      document.getElementById("output").innerText = JSON.stringify(res, null, 2);
    }
    async function sendMessageForm(e) {
      e.preventDefault();
      const form = new FormData(e.target);
      const body = new URLSearchParams();
      for (const [k,v] of form.entries()) body.append(k,v);
      const r = await fetch("/api/send", {method:"POST", body});
      const j = await r.json();
      document.getElementById("output").innerText = JSON.stringify(j, null, 2);
    }
  </script>
</head>
<body class="p-3">
  <div class="container">
    <div class="d-flex justify-content-between mb-2">
      <h4>ðŸ’¬ WhatsApp Bridge</h4>
      <div>
        <a href="/" class="btn btn-sm btn-outline-light">Back</a>
      </div>
    </div>

    <div class="card p-3 mb-3">
      <form method="post" action="/whatsapp">
        <div class="row">
          <div class="col-md-6 mb-2">
            <label>Base URL</label>
            <input name="base_url" class="form-control" value="{{ wa.base_url or '' }}">
          </div>
          <div class="col-md-3 mb-2">
            <label>Session</label>
            <input name="session_name" id="session_qr" class="form-control" value="{{ wa.session_name or 'default' }}">
          </div>
          <div class="col-md-3 mb-2">
            <label>&nbsp;</label>
            <div><button class="btn btn-success">Save</button></div>
          </div>
        </div>
      </form>
      <div class="mt-2 d-flex gap-2">
        <button class="btn btn-dark btn-sm" onclick="showSessions()">List sessions</button>
        <button class="btn btn-success btn-sm" onclick="connectSession()">Create session</button>
        <button class="btn btn-warning btn-sm" onclick="showQR()">Show QR</button>
        <button class="btn btn-info btn-sm" onclick="listGroups()">List groups</button>
        <button class="btn btn-secondary btn-sm" onclick="fetchGroups()">Fetch groups</button>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card p-3 mb-3">
          <h6>Send message</h6>
          <form onsubmit="sendMessageForm(event)">
            <div class="mb-2">
              <label>Number or Group ID</label>
              <input name="number" class="form-control" placeholder="628xx or 12036...@g.us">
            </div>
            <div class="mb-2">
              <label>Message</label>
              <textarea name="message" class="form-control" rows="4"></textarea>
            </div>
            <div class="mb-2">
              <label>Session</label>
              <input name="session" class="form-control" value="{{ wa.session_name or 'default' }}">
            </div>
            <div><button class="btn btn-primary">Send</button></div>
          </form>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card p-3">
          <h6>Output / Logs</h6>
          <div class="term" id="output">No output yet. Click buttons to call WA API.</div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

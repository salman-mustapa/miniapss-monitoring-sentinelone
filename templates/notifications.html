<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notification Settings - SentinelOne Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #0f4;
      --bg-dark: #0b0f10;
      --bg-card: #071012;
      --bg-panel: #00110a;
      --text-primary: #8aff9b;
      --text-secondary: #6a6;
      --border: #063;
    }
    
    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      font-family: "Courier New", monospace;
    }
    
    .card {
      background: var(--bg-card);
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .nav-tabs {
      border-bottom: 1px solid var(--primary);
    }
    
    .nav-tabs .nav-link {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      margin-right: 5px;
    }
    
    .nav-tabs .nav-link.active {
      background: var(--primary);
      border-color: var(--primary);
      color: #000;
    }
    
    .nav-tabs .nav-link:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .tab-content {
      padding: 20px 0;
    }
    
    .form-control, .form-select {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text-primary);
    }
    
    .form-control:focus, .form-select:focus {
      background: var(--bg-panel);
      border-color: var(--primary);
      color: var(--text-primary);
      box-shadow: 0 0 0 0.2rem rgba(0, 255, 68, 0.25);
    }
    
    .form-control::placeholder {
      color: #6a6;
    }
    
    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: #000;
    }
    
    .btn-outline-primary {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .btn-outline-primary:hover {
      background: var(--primary);
      color: #000;
    }
    
    .template-option {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .template-option:hover {
      background-color: var(--card-bg);
      border-color: var(--primary-color);
    }
    
    .template-option.selected {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }
    
    .template-option.selected .text-secondary {
      color: rgba(255, 255, 255, 0.8) !important;
    }
    
    .recipient-item {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="mb-0"><i class="fas fa-bell"></i> Notification Settings</h5>
      <div>
        <button class="btn btn-success btn-sm me-2" onclick="testNotifications()">
          <i class="fas fa-paper-plane"></i> Test Notifications
        </button>
        <a href="/" class="btn btn-outline-light btn-sm">
          <i class="fas fa-home"></i> Dashboard
        </a>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="notificationTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="whatsapp-tab" data-bs-toggle="tab" data-bs-target="#whatsapp" type="button" role="tab">
              <i class="fab fa-whatsapp me-2"></i>WhatsApp
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="telegram-tab" data-bs-toggle="tab" data-bs-target="#telegram" type="button" role="tab">
              <i class="fab fa-telegram me-2"></i>Telegram
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="teams-tab" data-bs-toggle="tab" data-bs-target="#teams" type="button" role="tab">
              <i class="fab fa-microsoft me-2"></i>Teams
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="notificationTabContent">
          <!-- WhatsApp Tab -->
          <div class="tab-pane fade show active" id="whatsapp" role="tabpanel">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Session</label>
                  <select id="waSession" class="form-select">
                    <option value="">Select session...</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Recipients (Phone numbers or Group IDs)</label>
                  <div class="input-group mb-2">
                    <input type="text" id="waRecipientInput" class="form-control" placeholder="Phone number or group ID">
                    <button class="btn btn-outline-primary" onclick="addWaRecipient()">
                      <i class="fas fa-plus"></i> Add
                    </button>
                  </div>
                  <div id="waRecipientsList" class="recipients-list"></div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Message Template</label>
                  <div id="waTemplates" class="mb-3"></div>
                  <textarea id="waCustomTemplate" class="form-control" rows="6" placeholder="Custom template..."></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- Telegram Tab -->
          <div class="tab-pane fade" id="telegram" role="tabpanel">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Bot Token</label>
                  <input type="text" id="tgBotToken" class="form-control" placeholder="Bot token from @BotFather">
                </div>
                
                <div class="mb-3">
                  <label class="form-label">Chat IDs</label>
                  <div class="input-group mb-2">
                    <input type="text" id="tgChatInput" class="form-control" placeholder="Chat ID or @username">
                    <button class="btn btn-outline-primary" onclick="addTgChat()">
                      <i class="fas fa-plus"></i> Add
                    </button>
                  </div>
                  <div id="tgChatsList" class="recipients-list"></div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Message Template</label>
                  <div id="tgTemplates" class="mb-3"></div>
                  <textarea id="tgCustomTemplate" class="form-control" rows="6" placeholder="Custom template..."></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- Teams Tab -->
          <div class="tab-pane fade" id="teams" role="tabpanel">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Webhook URLs</label>
                  <div class="input-group mb-2">
                    <input type="text" id="teamsWebhookInput" class="form-control" placeholder="Teams webhook URL">
                    <button class="btn btn-outline-primary" onclick="addTeamsWebhook()">
                      <i class="fas fa-plus"></i> Add
                    </button>
                  </div>
                  <div id="teamsWebhooksList" class="recipients-list"></div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Message Template</label>
                  <div id="teamsTemplates" class="mb-3"></div>
                  <textarea id="teamsCustomTemplate" class="form-control" rows="6" placeholder="Custom template..."></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Save Button and Process Logs -->
        <div class="row mt-4">
          <div class="col-md-6">
            <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()">
              <i class="fas fa-save me-2"></i>Save Settings
            </button>
          </div>
          <div class="col-md-6 text-end">
            <button type="button" class="btn btn-outline-primary" onclick="toggleProcessLogs()">
              <i class="fas fa-terminal me-2"></i>Show Process Logs
            </button>
          </div>
        </div>

        <!-- Process Logs Section -->
        <div id="processLogsSection" class="mt-4" style="display: none;">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">
                <i class="fas fa-terminal me-2"></i>Process Output Logs
              </h6>
              <div>
                <button class="btn btn-sm btn-outline-primary" onclick="clearNotificationLogs()">
                  <i class="fas fa-trash me-2"></i>Clear
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="toggleAutoScrollLogs()">
                  <i class="fas fa-arrow-down me-2"></i>Auto-scroll: <span id="autoScrollLogsStatus">ON</span>
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <div id="notificationLogs" class="terminal" style="height: 300px; overflow-y: auto; background: #000; color: #0f4; font-family: monospace; padding: 10px; white-space: pre-wrap;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Results Modal -->
  <div class="modal fade" id="testResultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" style="background: var(--bg-card); color: var(--text-primary);">
        <div class="modal-header" style="border-bottom: 1px solid var(--border);">
          <h5 class="modal-title">
            <i class="fas fa-paper-plane me-2"></i>Test Results
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
        </div>
        <div class="modal-body">
          <div id="testResults"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentConfig = {};
    let waRecipients = [];
    let tgChats = [];
    let teamsWebhooks = [];

    const templates = {
      whatsapp: [
        {
          name: "Basic Alert",
          template: "üö® *SentinelOne Alert*\n\n*Agent:* {{agent}}\n*Threat:* {{threat}}\n*Time:* {{timestamp}}"
        },
        {
          name: "Detailed Alert", 
          template: "üö® *SECURITY ALERT*\n\n*Agent:* {{agent}}\n*Threat:* {{threat}}\n*Time:* {{timestamp}}\n*File:* {{file}}\n\n‚ö†Ô∏è *Action Required:* Please investigate immediately"
        },
        {
          name: "Simple Alert",
          template: "üö® Alert: {{threat}} detected on {{agent}} at {{timestamp}}"
        }
      ],
      telegram: [
        {
          name: "Basic Alert",
          template: "üö® <b>SentinelOne Alert</b>\n\n<b>Agent:</b> {{agent}}\n<b>Threat:</b> {{threat}}\n<b>Time:</b> {{timestamp}}"
        },
        {
          name: "Detailed Alert",
          template: "üö® <b>SECURITY ALERT</b>\n\n<b>Agent:</b> {{agent}}\n<b>Threat:</b> {{threat}}\n<b>Time:</b> {{timestamp}}\n<b>File:</b> {{file}}\n\n‚ö†Ô∏è <i>Action Required: Please investigate immediately</i>"
        }
      ],
      teams: [
        {
          name: "Basic Alert",
          template: "üö® SentinelOne Alert\n\nAgent: {{agent}}\nThreat: {{threat}}\nTime: {{timestamp}}"
        },
        {
          name: "Detailed Alert",
          template: "üö® SECURITY ALERT\n\nAgent: {{agent}}\nThreat: {{threat}}\nTime: {{timestamp}}\nFile: {{file}}\n\nAction Required: Please investigate immediately"
        }
      ]
    };

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      renderTemplates();
      loadConfig();
      updateProcessLogs();
    });

    async function loadConfig() {
      try {
        const response = await fetch('/api/config');
        currentConfig = await response.json();
        
        // Load WhatsApp sessions
        await loadWaSessions();
        
        // Load existing settings from channels (legacy) or notifications
        const channels = currentConfig.channels || {};
        const notifications = currentConfig.notifications || {};
        
        // WhatsApp
        const waChannel = channels.whatsapp || {};
        const waNotif = notifications.whatsapp || {};
        document.getElementById('waSession').value = waNotif.session || waChannel.session_name || '';
        document.getElementById('waCustomTemplate').value = waNotif.template || '';
        waRecipients = waNotif.recipients || [];
        
        // Telegram
        const tgChannel = channels.telegram || {};
        const tgNotif = notifications.telegram || {};
        document.getElementById('tgBotToken').value = tgChannel.bot_token || '';
        document.getElementById('tgCustomTemplate').value = tgNotif.template || '';
        tgChats = tgNotif.chats || (tgChannel.chat_id ? [tgChannel.chat_id] : []);
        
        // Teams
        const teamsChannel = channels.teams || {};
        const teamsNotif = notifications.teams || {};
        document.getElementById('teamsCustomTemplate').value = teamsNotif.template || '';
        teamsWebhooks = teamsNotif.webhooks || (teamsChannel.webhook_url ? [teamsChannel.webhook_url] : []);
        
        // Update UI
        updateRecipientsList();
        
      } catch (error) {
        console.error('Failed to load config:', error);
      }
    }

    async function loadWaSessions() {
      try {
        const res = await fetch('/api/wa/sessions');
        const data = await res.json();
        const select = document.getElementById('waSession');
        
        select.innerHTML = '<option value="">Select session...</option>';
        if (data.sessions) {
          data.sessions.forEach(session => {
            const option = document.createElement('option');
            option.value = session.name;
            option.textContent = `${session.name} (${session.status === 'connected' ? 'Active' : 'Inactive'})`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Failed to load WA sessions:', error);
      }
    }

    function renderTemplates() {
      // WhatsApp templates
      const waContainer = document.getElementById('waTemplates');
      if (waContainer) {
        waContainer.innerHTML = templates.whatsapp.map((template, index) => `
          <div class="template-option" onclick="selectTemplate('whatsapp', ${index})">
            <strong>${template.name}</strong>
            <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 5px;">
              ${template.template.substring(0, 80)}...
            </div>
          </div>
        `).join('');
      }

      // Telegram templates
      const tgContainer = document.getElementById('tgTemplates');
      if (tgContainer) {
        tgContainer.innerHTML = templates.telegram.map((template, index) => `
          <div class="template-option" onclick="selectTemplate('telegram', ${index})">
            <strong>${template.name}</strong>
            <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 5px;">
              ${template.template.substring(0, 80)}...
            </div>
          </div>
        `).join('');
      }

      // Teams templates
      const teamsContainer = document.getElementById('teamsTemplates');
      if (teamsContainer) {
        teamsContainer.innerHTML = templates.teams.map((template, index) => `
          <div class="template-option" onclick="selectTemplate('teams', ${index})">
            <strong>${template.name}</strong>
            <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 5px;">
              ${template.template.substring(0, 80)}...
            </div>
          </div>
        `).join('');
      }
    }

    function selectTemplate(type, index) {
      // Remove previous selections for this type
      document.querySelectorAll(`#${type === 'whatsapp' ? 'wa' : type === 'telegram' ? 'tg' : 'teams'}Templates .template-option`).forEach(el => {
        el.classList.remove('selected');
      });
      
      // Add selection to clicked template
      const containerId = type === 'whatsapp' ? 'wa' : type === 'telegram' ? 'tg' : 'teams';
      const templateEl = document.querySelector(`#${containerId}Templates .template-option:nth-child(${index + 1})`);
      if (templateEl) {
        templateEl.classList.add('selected');
      }
      
      const template = templates[type][index];
      if (template) {
        const textareaId = type === 'whatsapp' ? 'waCustomTemplate' : type === 'telegram' ? 'tgCustomTemplate' : 'teamsCustomTemplate';
        document.getElementById(textareaId).value = template.template;
      }
    }

    function addWaRecipient() {
      const input = document.getElementById('waRecipientInput');
      const recipient = input.value.trim();
      if (recipient && !waRecipients.includes(recipient)) {
        waRecipients.push(recipient);
        input.value = '';
        updateRecipientsList();
      }
    }

    function addTgChat() {
      const input = document.getElementById('tgChatInput');
      const chat = input.value.trim();
      if (chat && !tgChats.includes(chat)) {
        tgChats.push(chat);
        input.value = '';
        updateRecipientsList();
      }
    }

    function addTeamsWebhook() {
      const input = document.getElementById('teamsWebhookInput');
      const webhook = input.value.trim();
      if (webhook && !teamsWebhooks.includes(webhook)) {
        teamsWebhooks.push(webhook);
        input.value = '';
        updateRecipientsList();
      }
    }

    function removeWaRecipient(index) {
      waRecipients.splice(index, 1);
      updateRecipientsList();
    }

    function removeTgChat(index) {
      tgChats.splice(index, 1);
      updateRecipientsList();
    }

    function removeTeamsWebhook(index) {
      teamsWebhooks.splice(index, 1);
      updateRecipientsList();
    }

    function updateRecipientsList() {
      // WhatsApp recipients
      const waList = document.getElementById('waRecipientsList');
      waList.innerHTML = waRecipients.map((recipient, index) => `
        <div class="recipient-item">
          <span>${recipient}</span>
          <button class="btn btn-sm btn-outline-danger" onclick="removeWaRecipient(${index})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('');

      // Telegram chats
      const tgList = document.getElementById('tgChatsList');
      tgList.innerHTML = tgChats.map((chat, index) => `
        <div class="recipient-item">
          <span>${chat}</span>
          <button class="btn btn-sm btn-outline-danger" onclick="removeTgChat(${index})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('');

      // Teams webhooks
      const teamsList = document.getElementById('teamsWebhooksList');
      teamsList.innerHTML = teamsWebhooks.map((webhook, index) => `
        <div class="recipient-item">
          <span>${webhook.substring(0, 50)}...</span>
          <button class="btn btn-sm btn-outline-danger" onclick="removeTeamsWebhook(${index})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('');
    }

    async function saveNotificationSettings() {
      try {
        const settings = {
          notifications: {
            whatsapp: {
              session: document.getElementById('waSession').value,
              recipients: waRecipients,
              template: document.getElementById('waCustomTemplate').value
            },
            telegram: {
              bot_token: document.getElementById('tgBotToken').value,
              chat_ids: tgChats,
              template: document.getElementById('tgCustomTemplate').value
            },
            teams: {
              webhook_urls: teamsWebhooks,
              template: document.getElementById('teamsCustomTemplate').value
            }
          }
        };
        
        const res = await fetch('/api/notifications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        
        if (res.ok) {
          alert('Notification settings saved successfully!');
        } else {
          const error = await res.json();
          alert('Failed to save settings: ' + error.error);
        }
      } catch (error) {
        alert('Error saving settings: ' + error.message);
      }
    }

    async function testNotifications() {
      try {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
        button.disabled = true;
        
        const response = await fetch('/api/test-notifications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        let resultsHtml = '';
        
        if (data.success) {
          if (data.results.success.length > 0) {
            resultsHtml += '<div class="alert alert-success"><h6><i class="fas fa-check-circle me-2"></i>Successful Tests:</h6><ul class="mb-0">';
            data.results.success.forEach(success => {
              resultsHtml += `<li>${success}</li>`;
            });
            resultsHtml += '</ul></div>';
          }
          
          if (data.results.errors.length > 0) {
            resultsHtml += '<div class="alert alert-danger"><h6><i class="fas fa-exclamation-triangle me-2"></i>Failed Tests:</h6><ul class="mb-0">';
            data.results.errors.forEach(error => {
              resultsHtml += `<li>${error}</li>`;
            });
            resultsHtml += '</ul></div>';
          }
          
          if (data.results.success.length === 0 && data.results.errors.length === 0) {
            resultsHtml = '<div class="alert alert-warning"><i class="fas fa-info-circle me-2"></i>No notification channels are configured or enabled.</div>';
          }
        } else {
          resultsHtml = `<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i>Test failed: ${data.error}</div>`;
        }
        
        document.getElementById('testResults').innerHTML = resultsHtml;
        new bootstrap.Modal(document.getElementById('testResultsModal')).show();
        
      } catch (error) {
        console.error('Test failed:', error);
        alert('Test failed: ' + error.message);
      } finally {
        const button = event.target.closest('button');
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    let notificationLogsContent = '';
    let autoScrollLogs = true;
    let logsVisible = false;

    function toggleProcessLogs() {
      const section = document.getElementById('processLogsSection');
      const button = event.target.closest('button');
      
      if (logsVisible) {
        section.style.display = 'none';
        button.innerHTML = '<i class="fas fa-terminal me-2"></i>Show Process Logs';
        logsVisible = false;
      } else {
        section.style.display = 'block';
        button.innerHTML = '<i class="fas fa-terminal me-2"></i>Hide Process Logs';
        logsVisible = true;
        startNotificationLogUpdates();
      }
    }

    function clearNotificationLogs() {
      notificationLogsContent = '';
      document.getElementById('notificationLogs').textContent = '';
    }

    function toggleAutoScrollLogs() {
      autoScrollLogs = !autoScrollLogs;
      document.getElementById('autoScrollLogsStatus').textContent = autoScrollLogs ? 'ON' : 'OFF';
    }

    function appendToNotificationLogs(message) {
      notificationLogsContent += message + '\n';
      const terminal = document.getElementById('notificationLogs');
      terminal.textContent = notificationLogsContent;
      
      if (autoScrollLogs) {
        terminal.scrollTop = terminal.scrollHeight;
      }
    }

    function startNotificationLogUpdates() {
      if (window.notificationLogInterval) {
        clearInterval(window.notificationLogInterval);
      }
      
      window.notificationLogInterval = setInterval(async () => {
        if (!logsVisible) return;
        
        try {
          const response = await fetch('/api/processes/logs');
          const data = await response.json();
          
          if (data.success && data.logs) {
            data.logs.forEach(log => {
              if (!notificationLogsContent.includes(log)) {
                appendToNotificationLogs(log);
              }
            });
          }
        } catch (error) {
          // Silently handle errors
        }
      }, 2000);
    }

    async function testNotifications() {
      try {
        const testData = {
          agent: "TEST-AGENT",
          threat: "Test Threat Detection",
          timestamp: new Date().toLocaleString(),
          file: "test_alert.json"
        };

        const response = await fetch('/api/test-notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(testData)
        });

        const result = await response.json();
        if (result.success) {
          showAlert('Test notifications sent successfully!', 'success');
        } else {
          showAlert('Failed to send test notifications: ' + result.message, 'danger');
        }
      } catch (error) {
        showAlert('Error sending test notifications: ' + error.message, 'danger');
      }
    }

    // Add Enter key support for inputs
    document.getElementById('waRecipientInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addWaRecipient();
    });
    
    document.getElementById('tgChatInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addTgChat();
    });
    
    document.getElementById('teamsWebhookInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addTeamsWebhook();
    });
  </script>
</body>
</html>
